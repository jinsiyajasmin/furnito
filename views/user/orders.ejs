<%- include('../../layout/header.ejs') %>

    <div class="page-wrapper">
        <header class="header">
            <div class="header-top">
                <div class="container">
                    <div class="header-left">
                        <div class="header-dropdown">
                            <a href="#">eng</a>
                            <div class="header-menu"></div><!-- End .header-menu -->
                        </div><!-- End .header-dropdown -->
                    </div><!-- End .header-left -->

                    <div class="header-right">
                        <ul class="top-menu">
                            <li>
                                <a href="#">Links</a>
                                <ul>
                                    <li><a href="/wishlist"><i class="icon-heart-o"></i>Wishlist <span></span></a></li>
                                    <% if (locals.user) { %>
                                        <li><a href="/logout">Logout</a></li>
                                        <li><a href="/userDashboard">
                                                <%=user.name%>
                                            </a></li>
                                        <% } else { %>
                                            <li><a href="/login"><i class="icon-user"></i>Login</a></li>
                                            <% } %>
                                </ul>
                            </li>
                        </ul><!-- End .top-menu -->
                    </div><!-- End .header-right -->
                </div><!-- End .container -->
            </div><!-- End .header-top -->

            <div class="header-middle sticky-header">
                <div class="container">
                    <div class="header-left">
                        <button class="mobile-menu-toggler">
                            <span class="sr-only">Toggle mobile menu</span>
                            <i class="icon-bars"></i>
                        </button>
                        <a href="index.html" class="logo">
                            <img src="assets/images/wonder.png" alt="Molla Logo" width="105" height="25">
                        </a>


                        <nav class="main-nav">
                            <ul class="menu sf-arrows">
                                <li >
                                    <a href="/" class="sf-with-ul">Home</a>
                                </li>
                                <li>
                                    <a href="/productList" class="sf-with-ul">Shop</a>
                                </li>

                            </ul><!-- End .menu -->
                        </nav><!-- End .main-nav -->
                    </div><!-- End .header-left -->

                    <div class="header-right">
                        <div class="dropdown cart-dropdown">
                            <a href="/cart"><i class="icon-shopping-cart" style="font-size: 24px;"></i></a>
                        </div>
                    </div><!-- End .header-right -->
                </div><!-- End .container -->
            </div><!-- End .header-middle -->
        </header><!-- End .header -->

        <main class="main">
            <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
                <div class="container">
                    <h1 class="page-title">My Account</h1>
                </div><!-- End .container -->
            </div><!-- End .page-header -->

            <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">My Account</li>
                    </ol>
                </div><!-- End .container -->
            </nav>

            <div class="page-content">
                <div class="dashboard">
                    <div class="container">
                        <div class="row">
                            <aside class="col-md-4 col-lg-3">
                                <ul class="nav nav-dashboard flex-column mb-3 mb-md-0" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link" href="/userDashboard">Dashboard</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/userProfile">Account Details</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link active" href="#tab-orders">Orders</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link " href="/userAddress">Addresses</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/wallet">Wallet</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/logout">Sign Out</a>
                                    </li>
                                </ul>
                            </aside>






                            <div class="col-md-4 col-lg-9">
                                <div class="tab-content">



                                    <div class="container mt-2">
                                        <% if (orders && orders.length> 0) { %>
                                            <% orders.forEach(order=> { %>
                                                <div class="card mb-2 order-card">
                                                    <div class="card-header bg-light">
                                                        <div class="row align-items-center">
                                                            <div class="col-md-6">
                                                                <h6 class="mb-0">Order #<%= order.orderId %>
                                                                </h6>
                                                            </div>
                                                            <div class="col-md-4 text-md-end">
                                                                <small class="text-muted">Ordered on <%= new
                                                                        Date(order.createdAt).toLocaleString('en-US', {
                                                                        year: 'numeric' , month: 'long' , day: 'numeric'
                                                                        }) %></small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row mb-3">
                                                            <div class="col-md">

                                                            </div>
                                                            <div class="col-md">
                                                                <strong>Payment Status:</strong>
                                                                <% if(order. paymentStatus==='Completed' ) { %>
                                                                    <span class="text-success">Completed</span>
                                                                    <% } else if(order. paymentStatus==='Failed' ) { %>
                                                                        <span class="text-danger">Failed</span>
                                                                        <% } else { %>
                                                                            <span class="text-warning">
                                                                                <%= order. paymentStatus %>
                                                                            </span>
                                                                            <% } %>
                                                            </div>
                                                            <% if (order.address) { %>
                                                                <div class="col-md">
                                                                    <strong>Ship to:</strong>
                                                                    <%= order.address.name %>,<br>
                                                                        <%= order.address.address %>,<br>
                                                                            <%= order.address.city %> - <%=
                                                                                    order.address.pincode %> <br>
                                                                                    <%= order.address.state %>
                                                                                        <%=order.address.phone %>
                                                                </div>
                                                                <% } %>
                                                        </div>

                                                        <% let showRepayButton=order.items.every(item=> item.status !==
                                                            'Cancelled') &&
                                                            ['Failed', 'Pending',
                                                            'Processing'].includes(order.paymentStatus); %>

                                                            <% if (showRepayButton) { %>
                                                                <button class="btn btn-warning"
                                                                    onclick="initiateRepayment('<%= order._id %>', '<%= order.total_amount %>')">
                                                                    Repay
                                                                </button>
                                                                <% } %>


                                                                    <button class="btn btn-outline-primary btn-sm"
                                                                        onclick="toggleOrderDetails('<%= order._id %>')">View
                                                                        Order Details</button>

                                                                    <div class="order-products mt-3"
                                                                        id="order-products-<%= order._id %>"
                                                                        style="display: none;">
                                                                        <h6 class="mb-3">Ordered Items:</h6>
                                                                        <div class="table-responsive">
                                                                            <table
                                                                                class="table table-sm table-borderless">
                                                                                <thead class="table-light">
                                                                                    <tr>
                                                                                        <th>Product</th>
                                                                                        <th>Price</th>
                                                                                        <th>Quantity</th>
                                                                                        <th>Total</th>
                                                                                        <th>Status</th>
                                                                                        <th>Action</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody>
                                                                                    <% order.items.forEach(item=> { %>
                                                                                        
                                                                                        <tr>
                                                                                            <td data-label="Product">
                                                                                                
                                                                                                <div
                                                                                                    class="d-flex align-items-center">
                                                                                                    
                                                                                                    <img src="/uploads/<%= item.product.productImage[0] %>"
                                                                                                        alt="<%= item.name %>"
                                                                                                        class="me-3"
                                                                                                        style="width: 60px; height: 60px; object-fit: cover;">
                                                                                                    
                                                                                                    <h6 class="mb-1">
                                                                                                        <%= item.name %>
                                                                                                    </h6>
                                                                                                     

                                                                                                </div>
                                                                                            </td>
                                                                                            <td data-label="Price">₹<%=
                                                                                                    item.price.toFixed(2)
                                                                                                    %>
                                                                                            </td>
                                                                                            <td data-label="Quantity">
                                                                                                <%= item.quantity %>
                                                                                            </td>
                                                                                            <td data-label="Total">₹<%=
                                                                                                        order.total_amount
                                                                                                    %>
                                                                                            </td>
                                                                                            <td data-label="Status">
                                                                                                <span
                                                                                                    class="badge bg-<%= item.status === 'Delivered' ? 'success' : 'primary' %>">
                                                                                                    <%= item.status %>
                                                                                                </span>
                                                                                            </td>
                                                                                            <td data-label="Action">
                                                                                                <% if
                                                                                                    (item.status==='Delivered'
                                                                                                    ) { %>
                                                                                                    <button
                                                                                                        class="btn btn-danger btn-sm"
                                                                                                        data-bs-toggle="modal"
                                                                                                        data-bs-target="#returnOrderModal<%= item._id %>">RETURN
                                                                                                        ORDER</button>
                                                                                                        <a href="/downloadInvoice?itemId=<%= item._id %>&orderId=<%= order.orderId %>"
                                                                                                            class="btn btn-primary btn-sm mt-1"
                                                                                                        target="_blank">GET
                                                                                                        INVOICE</a>
                                                                                                        
                                                                                                    <% } else if
                                                                                                        (['pending', 'Shipped'
                                                                                                        , 'Processing'
                                                                                                        ].includes(item.status)
                                                                                                        ) { %>
                                                                                                        <button
                                                                                                            class="btn btn-danger btn-sm"
                                                                                                            data-bs-toggle="modal"
                                                                                                            data-bs-target="#cancelOrderModal<%= item._id %>">CANCEL
                                                                                                            ORDER
                                                                                                        </button>
                                                                                                        <% } else if
                                                                                                            (item.status==='Cancelled'
                                                                                                            ) { %>
                                                                                                            <button
                                                                                                                class="btn btn-outline-secondary btn-sm"
                                                                                                                disabled>Cancelled</button>
                                                                                                            <% } %>
                                                                                            </td>
                                                                                        </tr>
                                                                                        <% }) %>
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                    </div>
                                                    </div>
                                                </div>
                                                <% }) %>
                                                    <% } else { %>

                                                        <div class="card text-center p-5">
                                                            <div class="card-body">
                                                                <img src="/api/placeholder/120/120" alt="Empty Cart"
                                                                    class="mb-3">
                                                                <h4 class="mb-3">No Orders Found</h4>
                                                                <p class="text-muted mb-4">Start shopping to see your
                                                                    orders here!</p>
                                                                <a href="/productList" class="btn btn-primary">Shop
                                                                    Now</a>
                                                            </div>
                                                        </div>
                                                        <% } %>
                                    </div>

                                </div>
                            </div>

                            <script>
                                function toggleOrderDetails(orderId) {
                                    const detailsElement = document.getElementById(`order-products-${orderId}`);
                                    detailsElement.style.display = detailsElement.style.display === 'none' ? 'block' : 'none';
                                }
                            </script>

















        </main>

        <footer class="footer">

            <div class="footer-middle">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-6 col-lg-3">
                            <div class="widget widget-about">
                                <img src="assets/images/wonder.png" class="footer-logo" alt="Footer Logo" width="150"
                                    height="25">
                                <p>Praesent dapibus, neque id cursus ucibus, tortor neque egestas augue, eu
                                    vulputate magna eros eu erat. </p>

                                <div class="widget-call">
                                    <i class="icon-phone"></i>
                                    Got Question? Call us 24/7
                                    <a href="tel:#">+0123 456 789</a>
                                </div><!-- End .widget-call -->
                            </div><!-- End .widget about-widget -->
                        </div><!-- End .col-sm-6 col-lg-3 -->

                        <div class="col-sm-6 col-lg-3">
                            <div class="widget">
                                <h4 class="widget-title">Useful Links</h4><!-- End .widget-title -->

                                <ul class="widget-list">
                                    <li><a href="about.html">About furnicom</a></li>
                                    <li><a href="#">Our Services</a></li>
                                    <li><a href="#">How to shop on furnicom</a></li>
                                    <li><a href="faq.html">FAQ</a></li>
                                    <li><a href="contact.html">Contact us</a></li>
                                </ul><!-- End .widget-list -->
                            </div><!-- End .widget -->
                        </div><!-- End .col-sm-6 col-lg-3 -->

                        <div class="col-sm-6 col-lg-3">
                            <div class="widget">
                                <h4 class="widget-title">Customer Service</h4><!-- End .widget-title -->

                                <ul class="widget-list">
                                    <li><a href="#">Payment Methods</a></li>
                                    <li><a href="#">Money-back guarantee!</a></li>
                                    <li><a href="#">Returns</a></li>
                                    <li><a href="#">Shipping</a></li>
                                    <li><a href="#">Terms and conditions</a></li>
                                    <li><a href="#">Privacy Policy</a></li>
                                </ul><!-- End .widget-list -->
                            </div><!-- End .widget -->
                        </div><!-- End .col-sm-6 col-lg-3 -->

                        <div class="col-sm-6 col-lg-3">
                            <div class="widget">
                                <h4 class="widget-title">My Account</h4><!-- End .widget-title -->

                                <ul class="widget-list">
                                    <li><a href="#">Sign In</a></li>
                                    <li><a href="cart.html">View Cart</a></li>
                                    <li><a href="#">My Wishlist</a></li>
                                    <li><a href="#">Track My Order</a></li>
                                    <li><a href="#">Help</a></li>
                                </ul><!-- End .widget-list -->
                            </div><!-- End .widget -->
                        </div><!-- End .col-sm-6 col-lg-3 -->
                    </div><!-- End .row -->
                </div><!-- End .container -->
            </div><!-- End .footer-middle -->

            <div class="footer-bottom">
                <div class="container">
                    <p class="footer-copyright">Copyright © 2024 furnicom Store. All Rights Reserved.</p>
                    <!-- End .footer-copyright -->
                    <figure class="footer-payments">
                        <img src="assets/images/payments.png" alt="Payment methods" width="272" height="20">
                    </figure><!-- End .footer-payments -->
                </div><!-- End .container -->
            </div><!-- End .footer-bottom -->
        </footer><!-- End .footer -->
    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay"></div><!-- End .mobil-menu-overlay -->

    <div class="mobile-menu-container">
        <div class="mobile-menu-wrapper">
            <span class="mobile-menu-close"><i class="icon-close"></i></span>

            <form action="#" method="get" class="mobile-search">
                <label for="mobile-search" class="sr-only">Search</label>
                <input type="search" class="form-control" name="mobile-search" id="mobile-search"
                    placeholder="Search in..." required>
                <button class="btn btn-primary" type="submit"><i class="icon-search"></i></button>
            </form>


            <div class="social-icons">
                <a href="#" class="social-icon" target="_blank" title="Facebook"><i class="icon-facebook-f"></i></a>
                <a href="#" class="social-icon" target="_blank" title="Twitter"><i class="icon-twitter"></i></a>
                <a href="#" class="social-icon" target="_blank" title="Instagram"><i class="icon-instagram"></i></a>
                <a href="#" class="social-icon" target="_blank" title="Youtube"><i class="icon-youtube"></i></a>
            </div><!-- End .social-icons -->
        </div>
    </div>


    </footer><!-- End .footer -->
    </div><!-- End .page-wrapper -->
    <% orders.forEach((item)=> { %>
        <% item.items.forEach(products=> { %>
            <div class="modal fade" id="cancelOrderModal<%= products._id %>" tabindex="-1"
                aria-labelledby="cancelOrderModalLabel<%= products._id %>" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content pr-5 pl-5">
                        <div class="modal-header">
                            <h6 class="modal-title" id="cancelOrderModalLabel<%= products._id %>">Cancel
                                Order</h6>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form id="cancelOrderForm<%= products._id %>" data-cancel-id="<%= products._id %>"
                            data-order-id="<%= item?.id %>" class="cancel-order-form">

                            <div class="modal-body">
                                <div class="mb-3 form-group">
                                    <label for="cancelReason<%= products._id %>" class="form-label errMsg">Reason for
                                        Cancellation</label>
                                    <textarea class="form-control" id="cancelReason<%= products._id %>"
                                        rows="3"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-danger">Cancel
                                    Order</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <% }) %>
                <% }) %>

                    <!-- Return Order Button -->
                    <% orders.forEach((item)=> { %>
                        <% item.items.forEach(products=> { %>



<!-- 
                            <% if (products.status==='Delivered' ) { %>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#returnOrderModal<%= products._id %>">
                                    Request Return
                                </button>
                                <% } %> -->




                                    <!-- Modal -->
                                    <div class="modal fade" id="returnOrderModal<%= products._id %>" tabindex="-1"
                                        aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Return Order</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="return_reason_<%= products._id %>"
                                                            class="form-label">Return Reason</label>
                                                        <textarea class="form-control"
                                                            id="return_reason_<%= products._id %>" rows="3"
                                                            placeholder="Explain the reason for returning this item"></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">Close</button>
                                                    <button type="button" class="btn btn-primary"
                                                        id="submitReturnRequest<%= products._id %>"
                                                        onclick="submitReturnRequest('<%= item._id %>', '<%= products._id %>')">
                                                        Submit Return Request
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% }) %>
                                        <% }) %>


                                            <script>
                                                function toggleDetails(orderId) {
                                                    const detailsDiv = document.getElementById(`details-${orderId}`);
                                                    const button = document.getElementById(`btn-${orderId}`);

                                                    if (detailsDiv.classList.contains('show')) {
                                                        detailsDiv.classList.remove('show');
                                                        button.textContent = 'View Details';
                                                    } else {
                                                        detailsDiv.classList.add('show');
                                                        button.textContent = 'Hide Details';
                                                    }
                                                }

                                                function cancelOrder(orderId) {
                                                    if (confirm('Are you sure you want to cancel this order?')) {
                                                        fetch(`/cancel-order/${orderId}`, {
                                                            method: 'POST',
                                                            headers: {
                                                                'Content-Type': 'application/json'
                                                            }
                                                        })
                                                            .then(response => response.json())
                                                            .then(data => {
                                                                if (data.success) {
                                                                    alert('Order cancelled successfully');
                                                                    window.location.reload();
                                                                } else {
                                                                    alert(data.message || 'Failed to cancel order');
                                                                }
                                                            })
                                                            .catch(error => {
                                                                console.error('Error:', error);
                                                                alert('An error occurred while cancelling the order');
                                                            });
                                                    }
                                                }
                                            </script>
                                            <script>
                                                const cancelOrderForm = document.querySelectorAll('.cancel-order-form')
                                                cancelOrderForm.forEach(form => {
                                                    form.addEventListener('submit', function (e) {
                                                        e.preventDefault();
                                                        const itemId = this.getAttribute('data-cancel-id')
                                                        const orderId = this.getAttribute('data-order-id')


                                                        const reason = document.getElementById(`cancelReason${itemId}`)
                                                        console.log(reason);

                                                        cancelFormValidate(reason, orderId, itemId)

                                                    });

                                                });

                                                async function cancelFormValidate(reason, orderId, itemId) {
                                                    const reasonValue = reason.value.trim();
                                                    let isValid = true;

                                                    const result = await Swal.fire({
                                                        title: 'Are you sure?',
                                                        text: "You won't be able to revert this!",
                                                        icon: 'warning',
                                                        showCancelButton: true,
                                                        confirmButtonColor: '#3085d6',
                                                        cancelButtonColor: '#d33',
                                                        confirmButtonText: 'Yes, cancel it!'
                                                    });
                                                    if (result.isConfirmed) {
                                                        try {
                                                            const response = await fetch('/cancelOrder', {
                                                                method: 'POST',
                                                                headers: {
                                                                    'Content-Type': 'application/json',
                                                                },
                                                                body: JSON.stringify({
                                                                    _id: orderId,
                                                                    cancel_reason: reasonValue,
                                                                    item_id: itemId
                                                                })
                                                            });
                                                            const data = await response.json();
                                                            if (data.success) {
                                                                Swal.fire(
                                                                    'Cancelled!',
                                                                    'Your Order has been canceled.',
                                                                    'success'
                                                                ).then(() => {
                                                                    location.reload();
                                                                });
                                                            } else {
                                                                Swal.fire(
                                                                    'Error!',
                                                                    data.message,
                                                                    'error'
                                                                );
                                                            }

                                                        } catch (error) {
                                                            console.error('Error during cancel order:', error);
                                                            Swal.fire(
                                                                'Error!',
                                                                'An error occurred while cancel the order.',
                                                                'error'
                                                            );

                                                        }
                                                    }
                                                }



                                                async function submitReturnRequest(orderId, productId) {
                                                    const textareaId = `return_reason_${productId}`;
                                                    const returnReasonElement = document.getElementById(textareaId);

                                                    if (!returnReasonElement) {
                                                        Swal.fire({
                                                            title: 'Error',
                                                            text: 'Could not find the return reason field. Please try again.',
                                                            icon: 'error',
                                                            confirmButtonText: 'OK',
                                                        });
                                                        return;
                                                    }

                                                    const returnReason = returnReasonElement.value.trim();

                                                    if (!returnReason) {
                                                        Swal.fire({
                                                            title: 'Error',
                                                            text: 'Please provide a reason for the return.',
                                                            icon: 'error',
                                                            confirmButtonText: 'OK',
                                                        });
                                                        return;
                                                    }

                                                    const submitButton = document.getElementById(`submitReturnRequest${productId}`);
                                                    if (submitButton) {
                                                        submitButton.disabled = true;
                                                        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
                                                    }

                                                    try {
                                                        const response = await fetch('/returnOrder', {
                                                            method: 'POST',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            credentials: 'include',
                                                            body: JSON.stringify({
                                                                order_id: orderId,
                                                                item_id: productId,
                                                                return_reason: returnReason,
                                                            }),
                                                        });

                                                        const data = await response.json();

                                                        if (response.ok) {
                                                            // Update the UI
                                                            const statusBadge = document.getElementById(`orderStatus${productId}`);
                                                            if (statusBadge) {
                                                                statusBadge.textContent = 'Return Requested';
                                                                statusBadge.className = 'badge bg-warning';
                                                            }

                                                            // Close the modal
                                                            const modalElement = document.getElementById(`returnOrderModal${productId}`);
                                                            const bootstrapModal = bootstrap.Modal.getInstance(modalElement);
                                                            if (bootstrapModal) bootstrapModal.hide();

                                                            Swal.fire({
                                                                title: 'Success',
                                                                text: 'Your return request has been submitted.',
                                                                icon: 'success',
                                                                confirmButtonText: 'OK',
                                                            }).then(() => {
                                                                location.reload();
                                                            });

                                                        } else {
                                                            throw new Error(data.message || 'Failed to submit the return request.');
                                                        }
                                                    } catch (error) {
                                                        Swal.fire({
                                                            title: 'Error',
                                                            text: error.message || 'An error occurred. Please try again.',
                                                            icon: 'error',
                                                            confirmButtonText: 'OK',
                                                        });
                                                    } finally {
                                                        if (submitButton) {
                                                            submitButton.disabled = false;
                                                            submitButton.innerHTML = 'Submit Return Request';
                                                        }
                                                    }
                                                }







                                            </script>

                                           









                                            <%- include ('../../layout/footer.ejs') %>