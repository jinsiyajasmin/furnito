<%- include ('../../layout/adminlayout/header.ejs') %>

<style>
  body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f0f0f0;
  }
  .form-container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .form-group {
      margin-bottom: 20px;
     
  }
  .form {
    margin-left: 30px;
  }
  label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
  }
  textarea, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
  }
  .image-upload-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
  }
  .image-upload-box {
      width: 200px;
      height: 200px;
      border: 2px dashed #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
  }
  .image-upload-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
  }
  .image-upload-box input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
  }
  .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
  }
  button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
  }

 
 
  .add-product-btn {
      background-color: #00b894;
      color: white;
      font-size: 16px;
      padding: 10px 20px;
      margin-top: 20px;
  }
</style>

  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5DDHKGP" height="0" width="0"
      style="display: none; visibility: hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- Layout wrapper -->
  <div class="layout-wrapper layout-content-navbar  ">
    <div class="layout-container">







      <!-- Menu -->

      <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">


        <div class="app-brand demo ">
         
          <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto">
            <i class="menu-toggle-icon d-xl-block align-middle"></i>
          </a>
        </div>

        <div class="menu-inner-shadow"></div>



        <ul class="menu-inner py-1">
          <!-- Dashboards -->
          <li class="menu-item">
           
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="dashboards-crm.html" class="menu-link">
                  <div data-i18n="CRM">CRM</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="index.html" class="menu-link">
                  <div data-i18n="Analytics">Analytics</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="app-ecommerce-dashboard.html" class="menu-link">
                  <div data-i18n="eCommerce">eCommerce</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="app-logistics-dashboard.html" class="menu-link">
                  <div data-i18n="Logistics">Logistics</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="app-academy-dashboard.html" class="menu-link">
                  <div data-i18n="Academy">Academy</div>
                </a>
              </li>
            </ul>
          </li>

          <!-- Layouts -->
          

          <!-- Front Pages -->
          
          <!-- e-commerce-app menu start -->
          <li class="menu-item active open">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class='menu-icon tf-icons ri-shopping-bag-3-line'></i>
              <div data-i18n="woodnwonder">woodnwonder</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="/admin/dashboard" class="menu-link">
                  <div data-i18n="Dashboard">Dashboard</div>
                </a>
              </li>
              <li class="menu-item active open">
                <a href="javascript:void(0);" class="menu-link menu-toggle">
                  <div data-i18n="Products">Products</div>
                </a>
                <ul class="menu-sub">
                  <li class="menu-item">
                    <a href="/admin/product" class="menu-link">
                      <div data-i18n="Product List">Product List</div>
                    </a>
                  </li>
                  <li class="menu-item active">
                    <a href="/admin/addProduct" class="menu-link">
                      <div data-i18n="Add Product">Add Product</div>
                    </a>
                  </li>
                </ul>
              </li>
              <li class="menu-item">
                <a href="javascript:void(0);" class="menu-link menu-toggle">
                  <div data-i18n="Category">Category</div>
                </a>
                <ul class="menu-sub">
                  <li class="menu-item">
                    <a href="/admin/category" class="menu-link">
                      <div data-i18n="List all category">List all category</div>
                    </a>
                  </li>
                </ul>
              </li>
              <li class="menu-item">
                <a href="javascript:void(0);" class="menu-link menu-toggle">
                  <div data-i18n="Order">Order</div>
                </a>
                <ul class="menu-sub">
                  <li class="menu-item">
                    <a href="/admin/orders" class="menu-link">
                      <div data-i18n="Order List">Order List</div>
                    </a>
                  </li>
        
                </ul>
              </li>
              <li class="menu-item">
                <a href="javascript:void(0);" class="menu-link menu-toggle">
                  <div data-i18n="Customer">Customer</div>
                </a>
                <ul class="menu-sub">
                  <li class="menu-item">
                    <a href="/admin/customers" class="menu-link">
                      <div data-i18n="All Customers">All Customers</div>
                    </a>
                  </li>
                </ul>
              </li>
              <li class="menu-item ">
                <a href="javascript:void(0);" class="menu-link menu-toggle">
                  <div data-i18n="Offers">Offers</div>
                </a>
                <ul class="menu-sub">
        
                  <li class="menu-item ">
                    <a href="/admin/offers" class="menu-link">
                      <div data-i18n="Product Offers">Product Offers</div>
                    </a>
                  </li>
                  <li class="menu-item">
                    <a href="/admin/offers/category" class="menu-link">
                      <div data-i18n="Category Offers">Category Offers</div>
                    </a>
                  </li>
                </ul>
              </li>
              <li class="menu-item ">
                <a href="javascript:void(0);" class="menu-link menu-toggle">
                  <div data-i18n="Coupons Management">Coupons Management</div>
                </a>
                <ul class="menu-sub">
        
                  <li class="menu-item ">
                    <a href="/admin/coupons" class="menu-link">
                      <div data-i18n="Coupen">Coupen</div>
                    </a>
                  </li>
                </ul>
              </li>
              <li class="menu-item">
                <a href="javascript:void(0);" class="menu-link menu-toggle">
                  <div data-i18n="Sales Report">Sales Report</div>
                </a>
                <ul class="menu-sub">
        
                  <li class="menu-item">
                    <a href="/admin/salesreport" class="menu-link">
                      <div data-i18n="Report">Report</div>
                    </a>
                  </li>
                </ul>
              </li>
             
            </ul>
          </li>
        </ul>
          <!-- e-commerce-app menu end -->
          
      </aside>
      <!-- / Menu -->

      <div class="layout-page">
        <form id="editProductForm" method="POST" action="/admin/editProduct/<%= product._id %>" enctype="multipart/form-data" class="form" onsubmit="return validateForm()">

          <input type="hidden" id="editProductId" name="productId" value="<%= product._id %>">
  
          <!-- Name Field -->
          <div class="mb-4">
              <label for="editProductName" class="form-label">Name</label>
              <input type="text" id="editProductName" name="productName" value="<%= product.productName %>" class="form-control border">
              <div id="name-error" class="error-message"></div>
          </div>
  
          <!-- Description Field -->
          <div class="mb-6">
              <label for="editProductDescription" class="form-label">Description</label>
              <textarea id="editProductDescription" name="productDescription" class="form-control border" rows="4"><%= product.productDescription %></textarea>
              <div id="description-error" class="error-message"></div>
          </div>
  
          <!-- Price, Stock, and Category Fields in Same Line -->
          <div class="row mb-4">
              <div class="col-lg-4">
                  <label class="form-label">Price</label>
                  <div class="input-group">
                      <span class="input-group-text">â‚¹</span>
                      <input type="number" step="0.01" id="editProductPrice" name="price" value="<%= product.price %>" class="form-control border" placeholder="0.00">
                  </div>
                  <div id="price-error" class="error-message"></div>
              </div>
  
              <div class="col-lg-4">
                  <label class="form-label">Stock</label>
                  <input id="editProductQuantity" name="quantity" type="number" value="<%= product.quantity %>" class="form-control border">
                  <div id="quantity-error" class="error-message"></div>
              </div>
  
              <div class="col-lg-4">
                <label class="form-label">Category</label>
                <select id="editProductCategory" class="form-select border" name="category">
                  <% categories.forEach(category => { %>
                      <option value="<%= category._id %>" 
                          <%= category._id.toString() === selectedCategoryId?.toString() ? 'selected' : '' %>>
                          <%= category.name %>
                      </option>
                  <% }) %>
              </select>
                
                <div id="category-error" class="error-message"></div>
            </div>
            
          
            
              <div class="col-lg-3">
                <label class="form-label">Status</label>
                <select class="form-select border" name="status">
                 
                  
                    <option value="active" "<%= product.status === 'active' ? 'selected' : '' %>" >Active</option>
                    <option value="inactive"  "<%= product.status === 'inactive' ? 'selected' : '' %>"   >Inactive</option>
                </select>
                <div id="status-error" class="error-message"></div>
            </div>
          </div>
  
      
          <div class="modal fade" id="cropperModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog" style="max-width: 1000px; margin: 10px auto;">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Crop Image</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-1">
                  <div style="max-width: 100%; height: 85vh;">
                    <img id="cropperImage" src="" alt="Image to crop" style="max-width: 100%; max-height: 100%; display: block;">
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" id="cropButton">Crop & Save</button>
                </div>
              </div>
            </div>
          </div>
          
         
          <div class="mb-4">
              <label class="form-label">Product Images</label>
              <div class="d-flex flex-wrap gap-3">
                  <% product.productImage.forEach((image, index) => { %>
                      <div class="d-flex flex-column align-items-center mb-3">
                          <div class="image-upload-box" data-upload-box="<%= index %>" 
                              style="width: 300px; height: 300px; border: 2px dashed #ddd; position: relative; overflow: hidden;">
                              <img src="/uploads/<%= image %>" alt="Preview" id="preview-<%= index %>" 
                                  style="max-width: 100%; max-height: 100%; object-fit: cover;">
                              <input type="file" name="images" accept="image/*" class="image-input" data-index="<%= index %>"
                                  style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                              <input type="hidden" name="croppedImages[]" id="cropped-<%= index %>">
                              <input type="hidden" name="existingImages[]" value="<%= image %>">
                          </div>
                          <small class="text-muted mt-2">Image <%= index + 1 %></small>
                      </div>
                  <% }) %>
              </div>
              <div id="images-error" class="error-message"></div>
          </div>
          <div>
              <button class="btn btn-primary" type="submit">Update Product</button>
          </div>
      </form>
      
    </div>


  
  
    
    <script>
     document.getElementById('editProductForm').addEventListener('submit', function (e) {
    e.preventDefault();

    if (validateForm()) {
        const formData = new FormData(this); 

        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: data.message,
                    confirmButtonText: 'OK'
                }).then(() => {
                    window.location.href = '/admin/product';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Something went wrong!'
            });
        });
    }
});

function validateForm() {
    let isValid = true;
    clearErrorMessages();

    // Fetch values
    const name = document.getElementById('editProductName').value.trim();
    const description = document.getElementById('editProductDescription').value.trim();
    const price = document.getElementById('editProductPrice').value;
    const quantity = document.getElementById('editProductQuantity').value;
    const category = document.getElementById('editProductCategory').value;
    const imageInputs = document.querySelectorAll('input[type="file"][name="images"]');

    // Basic validations
    if (name === "") {
        displayErrorMessage('name-error', 'Please enter a product name.');
        isValid = false;
    }

    if (description === "") {
        displayErrorMessage('description-error', 'Please enter a product description.');
        isValid = false;
    }

    if (price <= 0) {
        displayErrorMessage('price-error', 'Please enter a valid price.');
        isValid = false;
    }

    if (quantity < 0) {
        displayErrorMessage('quantity-error', 'Quantity cannot be negative.');
        isValid = false;
    }

    if (category === "") {
        displayErrorMessage('category-error', 'Please select a category.');
        isValid = false;
    }

    // Image validation
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    
    imageInputs.forEach((input, index) => {
        if (input.files.length > 0) {
            const file = input.files[0];
            if (!allowedTypes.includes(file.type)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid File Type',
                    text: `Image ${index + 1}: Only JPG, PNG, and GIF files are allowed.`,
                    confirmButtonColor: '#3085d6'
                });
                isValid = false;
            }
        }
    });

    return isValid;
}

function clearErrorMessages() {
    const errorElements = document.querySelectorAll('.error-message');
    errorElements.forEach(el => el.textContent = '');
}

function displayErrorMessage(id, message) {
    document.getElementById(id).textContent = message;
}

function previewImage(input, index) {
    const file = input.files[0];
    if (file) {
        // Validate file type before preview
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            input.value = ''; // Clear the input
            Swal.fire({
                icon: 'error',
                title: 'Invalid File Type',
                text: 'Please upload only JPG, PNG, or GIF images.',
                confirmButtonColor: '#3085d6'
            });
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-' + index).src = e.target.result;
        }
        reader.readAsDataURL(file);
    }
}



</script>

      
      
      
      
      <script>
        let cropper = null;
let currentImageInput = null;
let currentPreviewId = null;

// Add event listeners to all image inputs
document.addEventListener('DOMContentLoaded', function() {
    const imageInputs = document.querySelectorAll('.image-input');
    imageInputs.forEach(input => {
        input.addEventListener('change', function() {
            handleImageSelect(this);
        });
    });
});

function handleImageSelect(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        currentImageInput = input;
        currentPreviewId = input.dataset.index;

        const reader = new FileReader();
        reader.onload = function(e) {
            const cropperImage = document.getElementById('cropperImage');
            cropperImage.src = e.target.result;
            
            if (cropper) {
                cropper.destroy();
            }
            
            cropper = new Cropper(cropperImage, {
                aspectRatio: 2,
                viewMode: 1,
                responsive: true,
                background: false,
                modal: true,
                guides: true,
                center: true,
                highlight: true,
                autoCropArea: 0.95,
                dragMode: 'move',
                cropBoxResizable: true,
                cropBoxMovable: true,
                minCropBoxWidth: 400,
                minCropBoxHeight: 400,
                ready: function() {
                    this.cropper.resize();
                }
            });

            const modal = new bootstrap.Modal(document.getElementById('cropperModal'));
            modal.show();
        };
        reader.readAsDataURL(file);
    }
}

// Handle crop button click
document.getElementById('cropButton').addEventListener('click', function() {
    if (cropper) {
        const canvas = cropper.getCroppedCanvas({
            width: 800,
            height: 800,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });

        canvas.toBlob(function(blob) {
            const previewImage = document.getElementById(`preview-${currentPreviewId}`);
            previewImage.src = canvas.toDataURL();

            const croppedFile = new File([blob], `cropped_image_${currentPreviewId}.jpg`, { type: 'image/jpeg' });

            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(croppedFile);

            currentImageInput.files = dataTransfer.files;

            document.getElementById(`cropped-${currentPreviewId}`).value = canvas.toDataURL();

            const modal = bootstrap.Modal.getInstance(document.getElementById('cropperModal'));
            modal.hide();
        }, 'image/jpeg', 0.95);
    }
});

// Cleanup cropper when modal is hidden
document.getElementById('cropperModal').addEventListener('hidden.bs.modal', function() {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
});

// Modified form submission
document.getElementById('editProductForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Add existing images that weren't changed
    const existingImages = document.querySelectorAll('input[name="existingImages[]"]');
    existingImages.forEach((input, index) => {
        if (!formData.get(`images[${index}]`)) {
            formData.append(`existingImages[${index}]`, input.value);
        }
    });

    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = '/admin/product';
        } else {
            alert(data.message || 'Error updating product');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating product');
    });
});
      </script>

          

           
 








          <%- include ('../../layout/adminlayout/footer.ejs') %>